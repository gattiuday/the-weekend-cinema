<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Weekend Cinema (v1.3 Debug)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ES Module Shims (for better import map support/fallback) -->
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.8.2/dist/es-module-shims.js"></script>

  <!-- Import Map for React and Firebase -->
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
      "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
      "lucide-react": "https://esm.sh/lucide-react@0.294.0"
    }
  }
  </script>

  <!-- Crash Reporter -->
  <script>
    window.onerror = function (msg, url, lineNo, columnNo, error) {
      const errorDiv = document.createElement('div');
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '0';
      errorDiv.style.left = '0';
      errorDiv.style.width = '100%';
      errorDiv.style.background = 'red';
      errorDiv.style.color = 'white';
      errorDiv.style.padding = '20px';
      errorDiv.style.zIndex = '9999';
      errorDiv.textContent = `Error: ${msg} at ${lineNo}:${columnNo}`;
      document.body.appendChild(errorDiv);
      return false;
    };
    // Also catch unhandled promise rejections
    window.onunhandledrejection = function (event) {
      const errorDiv = document.createElement('div');
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '50px'; // Offset from previous
      errorDiv.style.left = '0';
      errorDiv.style.width = '100%';
      errorDiv.style.background = 'orange';
      errorDiv.style.color = 'white';
      errorDiv.style.padding = '20px';
      errorDiv.style.zIndex = '9999';
      errorDiv.textContent = `Promise Rejection: ${event.reason}`;
      document.body.appendChild(errorDiv);
    };
  </script>

  <!-- Babel Standalone (Debug Version) -->
  <script src="https://unpkg.com/@babel/standalone@7.26.2/babel.js" crossorigin="anonymous"></script>

  <!-- Configuration Loader Removed (Consumed directly by App.js) -->
</head>

<body class="bg-black text-white">
  <div id="root"></div>

  <!-- Manual Loader for App.js -->
  <script type="module">
    // Import React/ReactDOM for rendering
    import React from 'react';
    import { createRoot } from 'react-dom/client';

    async function loadApp() {
      try {
        // 1. Fetch Config
        let values = { FIREBASE_CONFIG: { apiKey: 'demo' }, APP_ID: 'demo', TMDB_KEY: '' };
        try {
          // Fetch text
          let configText = '';
          const r = await fetch('./config.js');
          if (r.ok) {
            configText = await r.text();
          } else {
            console.warn("config.js missing, using example");
            const r2 = await fetch('./config.example.js');
            if (r2.ok) configText = await r2.text();
          }

          if (configText) {
            // Robust Extraction: Strip 'export' keywords to avoid syntax errors in Function()
            // and manually return the variables we need.
            const cleanConfig = configText
              .replace(/export\s+const/g, 'const')
              .replace(/export\s+let/g, 'let')
              .replace(/export\s+var/g, 'var')
              .replace(/export\s+default/g, ''); // basic cleanup

            // Wrap in a function that returns the values. 
            // We use a try/catch inside the function function to be safe if a var is missing.
            const extractor = new Function(`
                ${cleanConfig}
                return { 
                  FIREBASE_CONFIG: (typeof FIREBASE_CONFIG !== 'undefined' ? FIREBASE_CONFIG : undefined),
                  APP_ID: (typeof APP_ID !== 'undefined' ? APP_ID : undefined),
                  TMDB_KEY: (typeof TMDB_KEY !== 'undefined' ? TMDB_KEY : undefined)
                };
             `);

            const extracted = extractor();
            if (extracted.FIREBASE_CONFIG) values.FIREBASE_CONFIG = extracted.FIREBASE_CONFIG;
            if (extracted.APP_ID) values.APP_ID = extracted.APP_ID;
            if (extracted.TMDB_KEY) values.TMDB_KEY = extracted.TMDB_KEY;
          }
        } catch (e) {
          console.error("Config extraction failed:", e);
        }

        // 2. INJECT GLOBALS (Critical for User's Code)
        window.__firebase_config = JSON.stringify(values.FIREBASE_CONFIG);
        window.__app_id = values.APP_ID;
        window.TMDB_KEY = values.TMDB_KEY;

        console.log("Globals Injected:", { appId: window.__app_id, tmdb: !!window.TMDB_KEY });

        // 3. Fetch App
        const response = await fetch('./App.js?t=' + Date.now());
        if (!response.ok) throw new Error(`Failed to load App.js: ${response.statusText}`);
        let appCode = await response.text();

        // CHECK FOR SOFT 404 (HTML returned instead of JS)
        if (appCode.trim().startsWith('<')) {
          console.error("App.js content appears to be HTML:", appCode.substring(0, 100));
          throw new Error("Failed to load App.js (Server returned HTML instead of Code). Check file paths.");
        }

        // 4. Transform JSX (React only)
        // We use 'env' but disable modules to keep 'import' statements for the browser to resolve via importmap
        const output = Babel.transform(appCode, {
          presets: [
            ['env', { modules: false, targets: { esmodules: true } }],
            ['react', { runtime: 'classic' }]
          ],
          filename: 'App.js',
          sourceType: 'module'
        });

        // 5. Run App
        const appBlob = new Blob([output.code], { type: 'text/javascript' });
        const appUrl = URL.createObjectURL(appBlob);

        // Import the module
        const AppModule = await import(appUrl);

        // 6. RENDER (This was missing!)
        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(AppModule.default));

        console.log("App rendered successfully");

      } catch (err) {
        console.error("Critical Boot Error:", err);
        // Show Red Screen of Death
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#330000;color:white;padding:20px;z-index:9999;font-family:monospace;overflow:auto;';
        errorDiv.innerHTML = `<h1>Critical Error</h1><pre>${err.stack || err.message}</pre>`;
        document.body.appendChild(errorDiv);
      }
    }
    loadApp();
  </script>
</body>

</html>